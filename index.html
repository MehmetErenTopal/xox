<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çok Oyunculu XOX</title>
    <!-- Inter yazı tipini ve Tailwind CSS'i yükleyin -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #111827;
            color: #E5E7EB;
        }
        .container {
            max-width: 600px;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 8px;
        }
        .cell {
            width: 100px;
            height: 100px;
            background: #1F2937;
            border: 2px solid #374151;
            font-size: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .cell:hover {
            background: #374151;
        }
        .cell.x {
            color: #F87171;
            font-weight: bold;
        }
        .cell.o {
            color: #60A5FA;
            font-weight: bold;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Ana Konteyner -->
    <div class="container mx-auto p-6 bg-gray-900 rounded-lg shadow-xl border border-gray-700">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-100">Çok Oyunculu XOX</h1>

        <!-- Giriş ve Oyun Başlatma Bölümü -->
        <div id="lobby" class="flex flex-col items-center space-y-4 hidden">
            <button id="createGameBtn" class="w-full py-3 px-6 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors duration-200">
                Yeni Çok Oyunculu Oyun Başlat
            </button>
            <div class="text-center text-gray-400">veya</div>
            <div class="w-full flex flex-col space-y-2">
                <input id="gameIdInput" type="text" placeholder="Oyun Kimliği Girin" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="joinGameBtn" class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-200">
                    Oyuna Katıl
                </button>
            </div>
            <div id="error-message" class="text-red-400 text-sm mt-2 hidden"></div>
        </div>

        <!-- Oyun Alanı Bölümü -->
        <div id="game-board-container" class="hidden flex flex-col items-center">
            <h2 class="text-xl font-semibold mb-4 text-center">
                Oyun Kimliği: <span id="gameIdDisplay" class="font-bold text-yellow-400"></span>
            </h2>
            <div id="status-message" class="text-lg font-bold text-center mb-4 min-h-[2rem]"></div>
            <div id="board" class="board mx-auto">
                <!-- Hücreler JS ile oluşturulacak -->
            </div>
            <button id="resetGameBtn" class="mt-6 py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors duration-200 hidden">
                Oyunu Sıfırla
            </button>
        </div>

        <!-- Yükleniyor ve Mesaj Kutusu -->
        <div id="loading" class="absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center">
            <div class="flex flex-col items-center space-y-4">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-400 border-t-blue-500"></div>
                <div id="loading-text" class="text-white text-lg font-medium">Yükleniyor...</div>
            </div>
        </div>

        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl border border-gray-700 text-center max-w-sm w-full">
                <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
                <p id="modal-message" class="text-gray-300 mb-6"></p>
                <button id="modal-close-btn" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">Tamam</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK'sını yükleyin -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Projenizin Firebase yapılandırma bilgilerini buraya girin.
        const firebaseConfig = {
          apiKey: "AIzaSyB1A05vbj1pvWoVd8fEpvFgCMaB7V7sE6E",
          authDomain: "xox-oyunu-6ee10.firebaseapp.com",
          projectId: "xox-oyunu-6ee10",
          storageBucket: "xox-oyunu-6ee10.firebasestorage.app",
          messagingSenderId: "522319916509",
          appId: "1:522319916509:web:844d13071f838532f11a34",
        };
        
        const appId = firebaseConfig.projectId;

        // UI elementlerini alın
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const gameIdInput = document.getElementById('gameIdInput');
        const lobby = document.getElementById('lobby');
        const gameBoardContainer = document.getElementById('game-board-container');
        const gameIdDisplay = document.getElementById('gameIdDisplay');
        const statusMessage = document.getElementById('status-message');
        const boardElement = document.getElementById('board');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const errorMessage = document.getElementById('error-message');

        const loadingOverlay = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');

        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Firebase ve Firestore nesneleri
        let app, db, auth;
        let userId = null;
        let gameId = null;
        let currentPlayerSymbol = null; // 'X' veya 'O'
        let unsubscribe = null; // onSnapshot dinleyicisini temizlemek için

        // Modalı göster
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        // Modalı gizle
        modalCloseBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Hata mesajını göster
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Hata mesajını gizle
        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
        }

        // Yükleme ekranını göster/gizle
        function showLoading(text) {
            loadingText.textContent = text;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Firebase başlatma ve kimlik doğrulama
        async function initializeFirebase() {
            try {
                showLoading("Firebase başlatılıyor...");
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        hideLoading();
                        lobby.classList.remove('hidden');
                        console.log("Oturum açıldı, Kullanıcı Kimliği:", userId);
                    } else {
                        // Eğer oturum açılmamışsa, anonim olarak oturum açmayı dene
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            showModal("Oturum Açma Hatası", "Oturum açılamadı. Firebase projenizde **Anonim Kimlik Doğrulama** etkinleştirilmiş mi lütfen kontrol edin.");
                            console.error("Oturum açma hatası:", error);
                            hideLoading();
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                showModal("Hata", "Firebase başlatılırken bir sorun oluştu. Yapılandırma bilgilerinizi kontrol edin.");
                hideLoading();
            }
        }

        // Oyunun başlangıç durumunu döndürür
        function getInitialState() {
            return {
                board: Array(9).fill(null),
                currentPlayer: 'X',
                players: {
                    X: null,
                    O: null
                },
                status: 'bekleniyor', // bekleniyor, oynuyor, kazandı, berabere
                lastUpdated: Date.now()
            };
        }

        // Oyun tahtasını ve durumu render et
        function renderBoard(board) {
            boardElement.innerHTML = '';
            board.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.classList.add('cell', 'rounded-lg', 'cursor-pointer');
                if (cell) {
                    cellElement.classList.remove('cursor-pointer');
                    cellElement.classList.add(cell === 'X' ? 'x' : 'o');
                    cellElement.textContent = cell;
                }
                cellElement.addEventListener('click', () => makeMove(index));
                boardElement.appendChild(cellElement);
            });
        }

        // Oyun durumuna göre mesaj oluştur
        function updateStatusMessage(gameData) {
            switch (gameData.status) {
                case 'bekleniyor':
                    statusMessage.textContent = 'İkinci oyuncu bekleniyor...';
                    break;
                case 'oynuyor':
                    const myTurn = gameData.players[gameData.currentPlayer] === userId;
                    statusMessage.textContent = myTurn ? 'Sıra Sende!' : `Sıra rakibinde.`;
                    break;
                case 'X-kazandı':
                    statusMessage.textContent = 'X kazandı!';
                    break;
                case 'O-kazandı':
                    statusMessage.textContent = 'O kazandı!';
                    break;
                case 'berabere':
                    statusMessage.textContent = 'Oyun Berabere!';
                    break;
                default:
                    statusMessage.textContent = '';
                    break;
            }
        }

        // Oyuncu hamlesini yap
        async function makeMove(index) {
            if (!gameId || !userId || !currentPlayerSymbol) {
                showModal("Hata", "Oyun bilgileri eksik. Lütfen oyuna yeniden katılın.");
                return;
            }

            const gameRef = doc(db, `artifacts/${appId}/public/data/xox-games`, gameId);
            const gameData = (await getDoc(gameRef)).data();
            
            // Eğer oyun durumu uygun değilse veya sıra sizde değilse hamle yapma
            if (gameData.status !== 'oynuyor' || gameData.players[gameData.currentPlayer] !== userId) {
                 showModal("Hata", "Sıra sizde değil veya oyun aktif değil.");
                 return;
            }

            // Hamle geçerli mi kontrol et
            if (gameData.board[index] === null) {
                showLoading("Hamle yapılıyor...");
                const newBoard = [...gameData.board];
                newBoard[index] = gameData.currentPlayer;

                const winner = checkWinner(newBoard);
                let newStatus = 'oynuyor';
                if (winner) {
                    newStatus = `${winner}-kazandı`;
                } else if (newBoard.every(cell => cell !== null)) {
                    newStatus = 'berabere';
                }

                const nextPlayer = gameData.currentPlayer === 'X' ? 'O' : 'X';
                
                try {
                    await setDoc(gameRef, {
                        board: newBoard,
                        currentPlayer: nextPlayer,
                        status: newStatus,
                        lastUpdated: Date.now()
                    }, { merge: true });
                } catch (e) {
                    showModal("Hata", "Hamle yapılırken bir hata oluştu: " + e.message);
                    console.error("Hamle hatası:", e);
                } finally {
                    hideLoading();
                }
            } else {
                 showModal("Hata", "Bu hücre dolu.");
            }
        }
        
        // Kazananı kontrol et
        function checkWinner(board) {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (let i = 0; i < lines.length; i++) {
                const [a, b, c] = lines[i];
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a];
                }
            }
            return null;
        }

        // Firestore dinleyicisini başlat
        function listenForGameChanges(id) {
            if (unsubscribe) unsubscribe();
            const gameRef = doc(db, `artifacts/${appId}/public/data/xox-games`, id);
            unsubscribe = onSnapshot(gameRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    renderBoard(data.board);
                    updateStatusMessage(data);
                    
                    if (data.status !== 'oynuyor' && data.status !== 'bekleniyor') {
                        resetGameBtn.classList.remove('hidden');
                        setTimeout(() => showModal("Oyun Bitti", statusMessage.textContent), 500);
                    } else {
                        resetGameBtn.classList.add('hidden');
                    }
                } else {
                    showModal("Hata", "Oyun bulunamadı veya silindi.");
                    // Lobby'ye geri dön
                    lobby.classList.remove('hidden');
                    gameBoardContainer.classList.add('hidden');
                    resetGameBtn.classList.add('hidden');
                    gameId = null;
                }
            }, (error) => {
                console.error("Oyun dinleyicisi hatası:", error);
                showModal("Veri Hatası", "Oyun durumu güncellenirken bir hata oluştu.");
            });
        }
        
        // Oyunu sıfırla
        resetGameBtn.addEventListener('click', async () => {
            if (!gameId) return;

            showLoading("Oyun sıfırlanıyor...");
            const gameRef = doc(db, `artifacts/${appId}/public/data/xox-games`, gameId);
            
            try {
                // Oyunu başlangıç durumuna döndür
                await setDoc(gameRef, getInitialState());
            } catch (e) {
                showModal("Hata", "Oyun sıfırlanırken bir hata oluştu: " + e.message);
                console.error("Sıfırlama hatası:", e);
            } finally {
                hideLoading();
            }
        });

        // Yeni oyun oluştur
        createGameBtn.addEventListener('click', async () => {
            if (!userId) {
                showModal("Hata", "Oturum henüz açılmadı, lütfen bekleyin.");
                return;
            }
            showLoading("Oyun oluşturuluyor...");
            try {
                const gamesCollection = collection(db, `artifacts/${appId}/public/data/xox-games`);
                const initialState = getInitialState();
                initialState.players.X = userId;
                
                const newGameRef = await addDoc(gamesCollection, initialState);
                gameId = newGameRef.id;
                gameIdDisplay.textContent = gameId;
                currentPlayerSymbol = 'X';
                
                // UI'ı güncelle
                lobby.classList.add('hidden');
                gameBoardContainer.classList.remove('hidden');
                
                listenForGameChanges(gameId);
                showModal("Oyun Oluşturuldu", `Oyun Kimliği: ${gameId}. Bu kimliği bir arkadaşınızla paylaşın!`);
            } catch (e) {
                showModal("Oyun Oluşturma Hatası", "Oyun oluşturulamadı. Lütfen tekrar deneyin.");
                console.error("Oyun oluşturma hatası:", e);
            } finally {
                hideLoading();
            }
        });

        // Oyuna katıl
        joinGameBtn.addEventListener('click', async () => {
            if (!userId) {
                showModal("Hata", "Oturum henüz açılmadı, lütfen bekleyin.");
                return;
            }
            const id = gameIdInput.value.trim();
            if (!id) {
                showErrorMessage("Lütfen geçerli bir oyun kimliği girin.");
                return;
            }
            hideErrorMessage();

            showLoading("Oyuna Katılınıyor...");
            const gameRef = doc(db, `artifacts/${appId}/public/data/xox-games`, id);
            try {
                const docSnap = await getDoc(gameRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.status !== 'bekleniyor' || data.players.O) {
                        showModal("Hata", "Bu oyun zaten başladı veya dolu.");
                        return;
                    }
                    
                    // Oyuncu O olarak oyuna katıl
                    gameId = id;
                    currentPlayerSymbol = 'O';
                    gameIdDisplay.textContent = gameId;

                    await setDoc(gameRef, {
                        players: {
                            ...data.players,
                            O: userId
                        },
                        status: 'oynuyor',
                        lastUpdated: Date.now()
                    }, { merge: true });
                    
                    // UI'ı güncelle
                    lobby.classList.add('hidden');
                    gameBoardContainer.classList.remove('hidden');
                    
                    listenForGameChanges(gameId);
                    showModal("Oyuna Katıldın", "Oyun başladı! Sıra X oyuncusunda.");
                } else {
                    showModal("Hata", "Oyun bulunamadı.");
                }
            } catch (e) {
                showModal("Oyuna Katılma Hatası", "Oyuna katılırken bir hata oluştu: " + e.message);
                console.error("Oyuna katılma hatası:", e);
            } finally {
                hideLoading();
            }
        });

        // Uygulamayı başlat
        window.onload = initializeFirebase;
    </script>
</body>
</html>
